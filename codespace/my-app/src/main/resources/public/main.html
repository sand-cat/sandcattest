<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlexiSolar</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>âš¡</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #edf2f7 100%);
            padding: 20px;
            color: #2d3748;
            line-height: 1.6;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .title {
            color: #2c5282;
            font-size: 40px;
            text-align: center;
            margin-bottom: 8px;
            font-weight: 600;
            background: linear-gradient(90deg, #2c5282, #3182ce);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            color: #718096;
            font-size: 16px;
            max-width: 700px;
            margin: 0 auto;
        }
        
        /* Single input row */
        .input-row {
            display: flex;
            gap: 12px;
            margin-bottom: 35px;
        }
        
        input {
            flex: 1;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            background: #f8fafc;
            transition: all 0.3s ease;
            color: #2d3748;
        }
        
        input:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
            background: white;
        }
        
        .add-btn {
            background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            min-width: 100px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(49, 130, 206, 0.2);
        }
        
        .add-btn:hover {
            background: linear-gradient(135deg, #2c5282 0%, #3182ce 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(49, 130, 206, 0.3);
        }
        
        /* Tables Container */
        .tables-container {
            display: grid;
            gap: 15px; /* CHANGED from 25px to 15px */
            margin-bottom: 20px; /* CHANGED from 30px to 20px */
        }
        
        /* Category Groups */
        .category-group {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: transform 0.3s ease;
        }
        
        .category-group:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .category-header {
            background: linear-gradient(90deg, #2c5282 0%, #3182ce 100%);
            color: white;
            padding: 18px 20px;
            font-weight: 600;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .category-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .category-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .category-content {
            padding: 15px; /* CHANGED from 25px to 15px */
        }
        

        /* Parameter Tables inside Category */
        .parameter-tables {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* ADDED this line */
            gap: 12px; /* CHANGED from 20px to 12px */
        }
        
        .parameter-table {
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
            transition: all 0.3s ease;
            height: fit-content; /* ADD this line */
        }
        
        .parameter-table:hover {
            border-color: #cbd5e0;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }
        
        .param-header {
            background: linear-gradient(90deg, #4c8bf5 0%, #3182ce 100%);
            color: white;
            padding: 12px 15px; /* CHANGED from 16px 20px to 12px 15px */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .param-name {
            font-weight: 600;
            font-size: 17px;
        }
        
        .delete-param-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .delete-param-btn:hover {
            background: #c53030;
            transform: scale(1.05);
        }
        
        .param-content {
            padding: 15px; /* CHANGED from 20px to 15px */
        }
        
        /* Input list inside parameter table */
        .inputs-list {
            display: flex;
            flex-direction: column;
            gap: 8px; /* CHANGED from 10px to 8px */
            margin-bottom: 15px; /* CHANGED from 20px to 15px */
            min-height: 40px;
        }
        
        .input-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px; /* CHANGED from 12px 15px to 10px 12px */
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }
        
        .input-item:hover {
            border-color: #cbd5e0;
            background: #f7fafc;
        }
        
        .input-name {
            font-size: 14px; /* CHANGED from 15px to 14px */
            color: #2d3748;
            font-weight: 500;
        }
        
        .delete-input-btn {
            background: #fed7d7;
            color: #c53030;
            border: none;
            width: 22px; /* CHANGED from 26px to 22px */
            height: 22px; /* CHANGED from 26px to 22px */
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px; /* CHANGED from 16px to 14px */
            font-weight: bold;
            transition: all 0.2s ease;
        }
        
        .delete-input-btn:hover {
            background: #feb2b2;
            transform: scale(1.1);
        }
        
        /* Add input to parameter */
        .add-input-row {
            display: flex;
            gap: 12px;
        }
        
        .add-input-row input {
            flex: 1;
            padding: 12px 15px;
            font-size: 15px;
        }
        
        .add-to-param-btn {
            background: #3182ce;
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .add-to-param-btn:hover {
            background: #2c5282;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #a0aec0;
            margin-bottom: 30px;
            background: #f8fafc;
            border-radius: 10px;
            border: 2px dashed #e2e8f0;
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: #718096;
            font-weight: 600;
            font-size: 20px;
        }
        
        .empty-state p {
            max-width: 500px;
            margin: 0 auto;
        }
        
        /* Formula Box */
        .formula-box {
            background: linear-gradient(135deg, #f0f9ff 0%, #e6f7ff 100%);
            border-radius: 10px;
            padding: 25px;
            border: 1px solid #bee3f8;
            margin-top: 25px;
        }
        
        .formula-title {
            color: #2c5282;
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .formula-title:before {
            content: "Î£";
            background: #3182ce;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .formula-content {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 22px;
            color: #2d3748;
            text-align: center;
            padding: 18px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            margin-top: 10px;
            font-weight: 600;
        }
        
        .formula-explanation {
            color: #718096;
            font-size: 15px;
            margin-top: 12px;
            text-align: center;
            line-height: 1.5;
        }
        
        /* Strength Input */
        .strength-section {
            background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%);
            border-radius: 10px;
            padding: 25px;
            border: 1px solid #fde68a;
            margin-top: 25px;
        }
        
        .strength-title {
            color: #d97706;
            font-weight: 600;
            margin-bottom: 18px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .strength-title:before {
            content: "âš¡";
            font-size: 20px;
        }
        
        .strength-input-row {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .strength-input-row label {
            font-weight: 600;
            min-width: 100px;
            color: #92400e;
        }
        
        .strength-input-row input {
            width: 80px;
            padding: 12px;
            border: 2px solid #f59e0b;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            color: #92400e;
            background: white;
        }
        
        .strength-input-row span {
            color: #718096;
            font-size: 14px;
        }
        
        .generate-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            padding: 14px 35px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(245, 158, 11, 0.2);
        }
        
        .generate-btn:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
        }
        
        .btn-container {
            text-align: center;
        }

        /* ===== Loading state ===== */
        .loading-message {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;

            height: 200px;
            font-size: 16px;
            color: #718096;
            text-align: center;
        }

        .loading-spinner {
            width: 36px;
            height: 36px;
            border: 4px solid #e2e8f000;
            border-top: 4px solid #3182ce;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
                
        /* Test Cases Output */
        .test-cases-section {
            background: linear-gradient(135deg, #f0fff4 0%, #e6fffa 100%);
            border-radius: 10px;
            padding: 25px;
            border: 1px solid #a7f3d0;
            margin-top: 25px;
            display: none;
        }
        
        .test-cases-title {
            color: #065f46;
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .test-cases-title:before {
            content: "âœ“";
            background: #10b981;
            color: white;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .test-cases-count {
            color: #047857;
            margin-bottom: 18px;
            text-align: center;
            font-weight: 500;
            padding: 8px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 6px;
        }
        
        .test-cases-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #d1fae5;
            border-radius: 8px;
            background: white;
            padding: 20px;
        }
        
        .test-case {
            padding: 12px 15px;
            margin-bottom: 12px;
            background: #f9fafb;
            border-radius: 6px;
            border-left: 4px solid #10b981;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            color: #1f2937;
            transition: all 0.2s ease;
        }
        
        .test-case:hover {
            background: #f3f4f6;
            transform: translateX(2px);
        }

        /* ===== MOBILE TOUCH & VISIBILITY FIX ===== */
@media (max-width: 480px) {

    button {
        min-height: 44px;
        font-size: 15px;
    }

    input {
        min-height: 44px;
        font-size: 16px;
    }

    .delete-input-btn {
        width: 36px;
        height: 36px;
        font-size: 18px;
    }

    .add-input-row {
        flex-direction: column;
        gap: 8px;
    }

    .add-to-param-btn {
        width: 100%;
        min-height: 44px;
    }

    .param-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }

    .delete-param-btn {
        width: 100%;
        min-height: 40px;
    }

    input[type="file"] {
        width: 100%;
        font-size: 15px;
        padding: 10px;
    }
}
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .parameter-tables {
        grid-template-columns: 1fr; /* Single column on mobile */
    }
    
    .category-content {
        padding: 12px; /* Even smaller padding on mobile */
    }

            .container {
                padding: 20px;
            }
            
            .input-row {
                flex-direction: column;
            }
            
            .add-btn {
                width: 100%;
            }
            
            .strength-input-row {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .strength-input-row span {
                margin-top: 5px;
            }
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        .footer {
    margin-top: 50px;
    padding: 30px 20px;
    text-align: center;
    border-top: 1px solid #e2e8f0;
    color: #4a5568;
    font-size: 14px;
}

.footer-logos {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 15px;
}

.footer-logos img {
    height: 80px;
    width: auto;
}


.footer-logo {
    opacity: 0.85;
}

.developers {
    margin-top: 10px;
    line-height: 1.6;
}

    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <div class="container">

        <div class="footer-logos">
        <img src="images/unimap logo.png" class="footer-logo" alt="UniMAP Logo">
        <img src="images/kpt-logo.png" class="footer-logo" alt="KPT Logo">
        <img src="images/thursinar.png" class="footer-logo" alt="Thursinar Logo">
    </div>

        <div class="header">
            <h1 class="title">FlexiSolar: Testing Tool for Solar Harvesting Application</h1>
            <p class="subtitle">Optimizing solar performance monitoring through advanced combinatorial test design to reduce false notifications and operational costs.</p>
        </div>
        
        <!-- Add Parameter -->
        <div class="input-row">
            <input type="text" id="paramInput" placeholder="Enter parameter name (e.g., 'Temperature', 'Browser', 'OS')">
            <button class="add-btn" onclick="addParameter()">Add Parameter</button>
        </div>

        <!-- XML Import / Export -->
        <div class="input-row">
            <input 
    type="file"
    id="xmlFileInput"
    accept=".xml,text/xml,application/xml,*/*"
    onchange="importFromXML(event)"
>
        </div>
        
        <!-- Tables Container (Grouped by input count) -->
        <div class="tables-container" id="tablesContainer">
            <!-- Categories will appear here -->
        </div>
        
        <!-- Empty State -->
        <div class="empty-state" id="emptyState">
            <h3>No Parameters Defined</h3>
            <p>Add your first parameter above to begin creating your testing matrix. Each parameter can have multiple input values.</p>
        </div>
        
        <!-- Formula Box -->
        <div class="formula-box" id="formulaBox" style="display: none;">
            <div class="formula-title">Configuration Space</div>
            <div class="formula-content" id="formulaText">2<sup>0</sup></div>
            <div class="formula-explanation" id="formulaExplanation">
                Total possible combinations based on parameters and their inputs
            </div>
        </div>
        
        <!-- Strength Input -->
        <div class="strength-section" id="strengthSection" style="display: none;">
            <div class="strength-title">Generate Test Cases</div>
            <div class="strength-input-row">
                <label for="strengthInput">Interaction Strength:</label>
                <input type="number" id="strengthInput" min="2" value="2">
            </div>
            <div class="btn-container">
                <button class="generate-btn" onclick="generateTestCasesBackend()">Generate Test Cases</button>
            </div>
        </div>
        
        <!-- Test Cases Output -->
        <div class="test-cases-section" id="testCasesSection">
            <div id="captureBox">

                <!-- âœ… PNG HEADER -->
        <div id="pngHeader" style="
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 18px;
            text-align: center;
        ">
            <div style="font-weight:600;">
                Configuration:
                <span id="pngConfig" style="color:#059669;"></span>
            </div>
            <div style="font-weight:500;">
                Interaction Strength (t):
                <span id="pngStrength" style="color:#2563eb;"></span>
            </div>
        </div>

            <div class="test-cases-title">Generated Test Cases</div>
            <div class="test-cases-count" id="testCasesCount">0 test cases generated</div>
            <div class="test-cases-container" id="testCasesContainer">
                <!-- Test cases will appear here -->
            </div>
            <div class="btn-container" style="margin-bottom:5px; margin-top: 15px;">
                            <button class="generate-btn" onclick="savePNG()">Save as PNG</button>
                            <button class="generate-btn" onclick="exportToXML()">Save as XML</button>
                            <button class="generate-btn" onclick="downloadText()">Save as TXT</button>
                        </div>
            </div>
        </div>

        <div class="footer">

    <div class="copyright">
        <strong>Â© 2026 FlexiSolar. All Rights Reserved</strong>
    </div>

    <div class="developers">
        <strong>Developed by Universiti Malaysia Perlis (UniMAP) and Thursinar Corporation Sdn Bhd</strong><br>
        <strong>This project is funded by the Ministry of Higher Education (KPT) Malaysia under the Industry Matching Program (IMaP)</strong><br>
        <strong>Legal & IP Registered Copyright: CRLYXXXXXX â€“ FlexiSolar: Testing Tool for Solar Harvesting Application</strong><br>
    </div>
</div>
    </div>

    <script>
        // Your existing JavaScript code remains exactly the same
        let parameters = []; // existing
        let inputEncoding = {}; 
        // inputEncoding[paramIndex] = { nameToNum: {}, numToName: {} }
        let lastRawResult = "";
        let lastStrength = 0;
        let lastValues = [];
        
        // Add new parameter table
        function addParameter() {
            const paramInput = document.getElementById('paramInput');
            const name = paramInput.value.trim();
            
            if (!name) {
                alert('Please enter a parameter name');
                return;
            }
            
            // Check if parameter already exists
            if (parameters.some(p => p.name === name)) {
                alert('Parameter already exists!');
                paramInput.select();
                return;
            }
            
            // Add parameter with empty inputs
            parameters.push({
                name: name,
                inputs: []
            });
            
            // Clear input
            paramInput.value = '';
            paramInput.focus();
            
            // Update display
            updateTables();
            updateFormula();
        }
        
        // Remove parameter table
        function removeParameter(index) {
            if (confirm('Delete this parameter and all its inputs?')) {
                parameters.splice(index, 1);
                updateTables();
                updateFormula();
            }
        }
        
        // Add input to a specific parameter
        function addInputToParameter(paramIndex) {
            const inputField = document.getElementById(`inputField-${paramIndex}`);
            const inputName = inputField.value.trim();

            if (!inputName) {
                alert('Please enter an input name');
                return;
            }

            // init encoding for parameter if not exist
            if (!inputEncoding[paramIndex]) {
                inputEncoding[paramIndex] = {
                    nameToNum: {},
                    numToName: {}
                };
            }

            const nextNum = parameters[paramIndex].inputs.length + 1;

            inputEncoding[paramIndex].nameToNum[inputName] = nextNum;
            inputEncoding[paramIndex].numToName[nextNum] = inputName;

            parameters[paramIndex].inputs.push(inputName);

            inputField.value = '';
            inputField.focus();

            updateTables();
            updateFormula();
        }
        
        // Remove input from parameter
        function removeInputFromParameter(paramIndex, inputIndex) {
            parameters[paramIndex].inputs.splice(inputIndex, 1);

            // rebuild encoding (VERY IMPORTANT)
            inputEncoding[paramIndex] = { nameToNum: {}, numToName: {} };

            parameters[paramIndex].inputs.forEach((name, i) => {
                const num = i + 1;
                inputEncoding[paramIndex].nameToNum[name] = num;
                inputEncoding[paramIndex].numToName[num] = name;
            });

            updateTables();
            updateFormula();
        }
        
        // Group parameters by number of inputs and update display
        function updateTables() {
            const tablesContainer = document.getElementById('tablesContainer');
            const emptyState = document.getElementById('emptyState');
            const strengthSection = document.getElementById('strengthSection');
            
            if (parameters.length === 0) {
                tablesContainer.innerHTML = '';
                emptyState.style.display = 'block';
                strengthSection.style.display = 'none';
                return;
            }
            
            emptyState.style.display = 'none';
            strengthSection.style.display = 'block';
            
            // Group parameters by input count
            const groups = {};
            parameters.forEach((param, index) => {
                const inputCount = param.inputs.length;
                if (!groups[inputCount]) {
                    groups[inputCount] = [];
                }
                groups[inputCount].push({...param, originalIndex: index});
            });
            
            // Sort groups by input count (0 inputs first, then 1, 2, 3...)
            const sortedGroups = Object.entries(groups).sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
            
            let html = '';
            
            sortedGroups.forEach(([inputCount, params]) => {
                const categoryName = inputCount === '0' ? 'No Inputs' : 
                                   inputCount === '1' ? '1 Input' : 
                                   `${inputCount} Inputs`;
                
                html += `
                    <div class="category-group">
                        <div class="category-header">
                            <div class="category-title">
                                <span>${categoryName}</span>
                                <span class="category-count">${params.length} parameter${params.length > 1 ? 's' : ''}</span>
                            </div>
                        </div>
                        
                        <div class="category-content">
                            <div class="parameter-tables">
                                ${params.map(param => `
                                    <div class="parameter-table">
                                        <div class="param-header">
                                            <div class="param-name" title="${param.name}">${param.name.length > 15 ? param.name.substring(0, 15) + '...' : param.name}</div>
                                            <button class="delete-param-btn" onclick="removeParameter(${param.originalIndex})">Delete</button>
                                        </div>
                                        
                                        <div class="param-content">
                                            <div class="inputs-list">
                                                ${param.inputs.length === 0 ? 
                                                    `<div style="text-align: center; padding: 15px; color: #a0aec0; font-style: italic;">
                                                        No inputs defined
                                                    </div>` : ''
                                                }
                                                
                                                ${param.inputs.map((input, inputIndex) => `
                                                    <div class="input-item">
                                                        <div class="input-name" title="${input}">${input.length > 20 ? input.substring(0, 20) + '...' : input}</div>
                                                        <button class="delete-input-btn" onclick="removeInputFromParameter(${param.originalIndex}, ${inputIndex})">Ã—</button>
                                                    </div>
                                                `).join('')}
                                            </div>
                                            
                                            <div class="add-input-row">
                                                <input type="text" id="inputField-${param.originalIndex}" placeholder="Add input to ${param.name}">
                                                <button class="add-to-param-btn" onclick="addInputToParameter(${param.originalIndex})">Add</button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            tablesContainer.innerHTML = html;
            
            // Add Enter key support for all input fields
            parameters.forEach((param, index) => {
                const inputField = document.getElementById(`inputField-${index}`);
                if (inputField) {
                    inputField.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            addInputToParameter(index);
                        }
                    });
                }
            });
        }
        
        // Calculate and update formula (only formula, no result)
        function updateFormula() {
            const formulaBox = document.getElementById('formulaBox');
            const formulaText = document.getElementById('formulaText');
            const formulaExplanation = document.getElementById('formulaExplanation');
            
            if (parameters.length === 0) {
                formulaBox.style.display = 'none';
                return;
            }
            
            formulaBox.style.display = 'block';
            
            // Group parameters by number of inputs (excluding those with 0 inputs)
            const inputCounts = {};
            
            parameters.forEach(param => {
                const count = param.inputs.length;
                if (count > 0) {
                    if (!inputCounts[count]) {
                        inputCounts[count] = 0;
                    }
                    inputCounts[count]++;
                }
            });
            
            // Create formula string (e.g., 2Â² Ã— 3Â¹ Ã— 4Â²)
            let formulaParts = [];
            
            // Sort input counts ascending
            const sortedCounts = Object.entries(inputCounts).sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
            
            for (const [inputCount, paramCount] of sortedCounts) {
                if (paramCount > 0) {
                    formulaParts.push(`${inputCount}<sup>${paramCount}</sup>`);
                }
            }        
            // Handle case where all parameters have 0 inputs
            if (formulaParts.length === 0) {
                formulaText.innerHTML = "2<sup>0</sup>";
                formulaExplanation.textContent = "No inputs in any parameter yet";
                return;
            }
            
            // Create the formula display (only the formula, no equals sign)
            const formulaString = formulaParts.join("Ã—");
            formulaText.innerHTML = formulaString;
            
            // Create explanation
            let explanationParts = [];
            for (const [inputCount, paramCount] of sortedCounts) {
                if (paramCount > 0) {
                    explanationParts.push(`${paramCount} parameter${paramCount > 1 ? 's' : ''} with ${inputCount} input${inputCount > 1 ? 's' : ''}`);
                }
            }
            
            const explanation = explanationParts.join(", ");
            formulaExplanation.textContent = `Parameters grouped by number of inputs: ${explanation}`;
        }

        async function generateTestCasesBackend() {
            const strength = parseInt(document.getElementById('strengthInput').value) || 2;

            const section = document.getElementById('testCasesSection');
            const container = document.getElementById('testCasesContainer');
            const count = document.getElementById('testCasesCount');
            const generateBtn = document.querySelector('.strength-section .generate-btn');

            const validParams = parameters.filter(p => p.inputs.length > 0);
            const paramValue = validParams.length; // k = number of parameters

            if (validParams.length === 0) {
                alert("No parameters with inputs");
                generateBtn.disabled = false;
                return;
            }

            // Rule 1: strength must be >= 1
if (strength < 1) {
    document.getElementById('testCasesSection').style.display = 'block';
    document.getElementById('testCasesCount').innerHTML = `
        <div class="error-message gateway-message">
            <strong>Invalid Interaction Strength</strong>
            <p>Interaction strength must be a positive integer.</p>
            <p><strong>Required condition:</strong></p>
            <p style="font-family: monospace; text-align: center;">t â‰¥ 1</p>
        </div>
    `;
    return;
}

// Rule 2: strength must not exceed number of parameters
if (strength > paramValue) {
    document.getElementById('testCasesSection').style.display = 'block';
    document.getElementById('testCasesCount').innerHTML = `
        <div class="error-message gateway-message">
            <strong>Invalid Configuration</strong>
            <p>
                Interaction strength (<strong>t = ${strength}</strong>) must not exceed
                the number of parameters (<strong>k = ${paramValue}</strong>).
            </p>
            <p><strong>Required condition:</strong></p>
            <p style="font-family: monospace; text-align: center;">
                1 â‰¤ t â‰¤ k
            </p>
        </div>
    `;
    return;
}

            const values = validParams.map(p => p.inputs.length);
            const valuesStr = values.join(",");

            const baseUrl = "/generate";
            const url = `${baseUrl}?strength=${strength}&values=${valuesStr}`;

                section.style.display = 'block';

            container.innerHTML = `
                <div class="loading-message">
                    <div class="loading-spinner"></div>
                    <div>
                        Calculating test suite...<br>
                        <small>Please wait while the system processes your request</small>
                    </div>
                </div>
            `;

            count.textContent = "Processingâ€¦";

            const originalText = generateBtn.textContent;
            generateBtn.textContent = "Processingâ€¦";
            generateBtn.disabled = true;

            let raw;
            try {
                const res = await fetch(url);
                raw = await res.text();
            } catch (e) {
                container.innerHTML = `
                    <div class="loading-message">
                        <strong>Failed to generate test suite</strong><br>
                        Please try again.
                    </div>
                `;
                count.textContent = "0 test cases generated";
                generateBtn.textContent = originalText;
                generateBtn.disabled = false;
                return;
            }

            lastRawResult = raw;
            lastStrength = strength;
            lastValues = values;

            const decoded = decodeBackendResult(raw, validParams);

            renderDecodedResults(decoded, strength);

            generateBtn.textContent = originalText;
            generateBtn.disabled = false;
        }
        
        function decodeRawResultToNames(raw) {
            return raw
                .split("\n")
                .filter(line => /^\d+\)/.test(line))
                .map(line => {
                    const nums = line
                        .replace(/^\d+\)\s*/, "")
                        .trim()
                        .split(/\s+/)
                        .map(Number);

                    const names = nums.map((n, i) =>
                        inputEncoding[i]?.numToName[n] ?? n
                    );

                    return `${line.split(")")[0]}) ${names.join(", ")}`;
                })
                .join("\n");
        }

        function decodeBackendResult(raw, validParams) {
            const lines = raw.split("\n");

            return lines.map(line => {
                if (!line.match(/^\d+\)/)) return line;

                const nums = line
                    .replace(/^\d+\)\s*/, "")
                    .trim()
                    .split(/\s+/)
                    .map(Number);

                const names = nums.map((n, i) =>
                    inputEncoding[i].numToName[n]
                );

                return `${line.split(")")[0]}) ${names.join(", ")}`;
            });
        }

        function renderDecodedResults(results, strength) {
    const section = document.getElementById('testCasesSection');
    const count = document.getElementById('testCasesCount');
    const container = document.getElementById('testCasesContainer');

    container.innerHTML = '';

    results.forEach(r => {
        const div = document.createElement('div');
        div.className = 'test-case';
        div.textContent = r;
        container.appendChild(div);
    });

    const realCases = results.filter(r => /^\d+\)/.test(r));

    // âœ… STORE FINAL STATE (single source of truth)
    lastRawResult = realCases.join("\n");
    lastStrength = document.getElementById("strengthInput")?.value || strength;
    lastValues = parameters.filter(p => p.inputs.length > 0).map(p => p.inputs.length);

    // UI count
    count.textContent = `${realCases.length} test cases generated`;

    // âœ… PNG HEADER DATA
    const pngConfigEl = document.getElementById("pngConfig");
    const pngStrengthEl = document.getElementById("pngStrength");

    if (pngConfigEl) pngConfigEl.textContent = lastValues.join(", ");
    if (pngStrengthEl) pngStrengthEl.textContent = lastStrength;

    section.style.display = 'block';
    section.scrollIntoView({ behavior: 'smooth' });
}
        
                function exportToXML() {
            if (parameters.length === 0) {
                alert("No configuration to export.");
                return;
            }

            const strength = document.getElementById('strengthInput')?.value || 2;

            let xml = `<?xml version="1.0" encoding="UTF-8"?>\n`;
            xml += `<combinatorialTestDesign>\n`;
            xml += `  <interactionStrength>${strength}</interactionStrength>\n`;
            xml += `  <parameters>\n`;

            parameters.forEach(p => {
                if (p.inputs.length === 0) return;

                xml += `    <parameter name="${escapeXML(p.name)}">\n`;
                p.inputs.forEach(v => {
                    xml += `      <value>${escapeXML(v)}</value>\n`;
                });
                xml += `    </parameter>\n`;
            });

            xml += `  </parameters>\n`;

                        if (lastRawResult) {
                const decodedForXML = decodeBackendResult(
                    lastRawResult,
                    parameters.filter(p => p.inputs.length > 0)
                ).join("\n");

                xml += `  <generatedTestSuite><![CDATA[\n${decodedForXML}\n]]></generatedTestSuite>\n`;
            }

            xml += `</combinatorialTestDesign>`;

            const blob = new Blob([xml], { type: "application/xml" });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = "tway-test-configuration.xml";
            a.click();

            URL.revokeObjectURL(url);
        }

        function escapeXML(str) {
            return str.replace(/[<>&'"]/g, c =>
                ({ '<':'&lt;', '>':'&gt;', '&':'&amp;', "'":'&apos;', '"':'&quot;' }[c])
            );
        }

        function importFromXML(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = () => parseXML(reader.result);
            reader.readAsText(file);
        }

        function parseXML(xmlText) {
            const parser = new DOMParser();
            const xml = parser.parseFromString(xmlText, "application/xml");

            const strengthNode = xml.querySelector("interactionStrength");
            if (strengthNode) {
                document.getElementById("strengthInput").value = strengthNode.textContent;
            }

            const paramNodes = xml.querySelectorAll("parameter");

            parameters = [];
            inputEncoding = {};

            paramNodes.forEach((pNode, idx) => {
                const name = pNode.getAttribute("name");
                const values = [...pNode.querySelectorAll("value")].map(v => v.textContent);

                parameters.push({ name, inputs: values });

                inputEncoding[idx] = { nameToNum: {}, numToName: {} };
                values.forEach((val, i) => {
                    inputEncoding[idx].nameToNum[val] = i + 1;
                    inputEncoding[idx].numToName[i + 1] = val;
                });
            });

            updateTables();
            updateFormula();

            // âœ… ADD FROM HERE â†“â†“â†“
            const resultNode = xml.querySelector("generatedTestSuite");

            if (resultNode) {
                const text = resultNode.textContent.trim();

                const results = text
                    .split("\n")
                    .map(l => l.trim())
                    .filter(l => l);

                renderDecodedResults(results);

                // restore session state
                lastRawResult = text;
                lastStrength = document.getElementById("strengthInput").value;
                lastValues = parameters.map(p => p.inputs.length);
            }
        }

        async function savePNG() {
    const box = document.getElementById("captureBox");
    const container = document.getElementById("testCasesContainer");

    // ðŸ” Save original styles
    const originalMaxHeight = container.style.maxHeight;
    const originalOverflow = container.style.overflowY;

    // ðŸ”“ Expand container to show ALL test cases
    container.style.maxHeight = "none";
    container.style.overflowY = "visible";

    // Force layout reflow
    await new Promise(resolve => setTimeout(resolve, 50));

    const canvas = await html2canvas(box, {
        scale: 2,
        backgroundColor: "#ffffff",
        windowWidth: box.scrollWidth,
        windowHeight: box.scrollHeight
    });

    // ðŸ” Restore original styles
    container.style.maxHeight = originalMaxHeight;
    container.style.overflowY = originalOverflow;

    const imgData = canvas.toDataURL("image/png");
    const link = document.createElement("a");
    link.href = imgData;
    link.download = "TestSuite.png";
    link.click();
}

        function downloadText() {
    if (!lastRawResult) {
        alert("No test suite generated yet.");
        return;
    }

    let outputText;

    // âœ… Check if result already contains names (not numbers)
    const hasNames = /[a-zA-Z]/.test(lastRawResult);

    if (hasNames) {
        // Already decoded (from XML import)
        outputText = lastRawResult
            .split("\n")
            .filter(l => l.trim())
            .join("\n");
    } else {
        // Numeric result â†’ decode normally
        outputText = decodeRawResultToNames(lastRawResult);
    }

    const count = outputText
        .split("\n")
        .filter(line => /^\d+\)/.test(line))
        .length;

    const header =
`Test Suite
Interaction Strength (t): ${lastStrength}
Values: [${lastValues.join(", ")}]`;

    const footer = `Completed with ${count} test cases.`;

    const finalText = `${header}\n\n${outputText}\n\n${footer}`;

    const blob = new Blob([finalText], { type: "text/plain" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "TestSuite.txt";
    link.click();
}

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Enter key support for parameter input
            document.getElementById('paramInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addParameter();
                }
            });
            
            // Enter key support for strength input
            document.getElementById('strengthInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    generateTestCasesBackend();
                }
            });
             
            updateTables();
            updateFormula();
        });
    </script>
</body>
</html>